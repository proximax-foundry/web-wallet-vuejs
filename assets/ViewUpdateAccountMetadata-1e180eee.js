import{q as Oe,r as m,I as Qe,c as v,w as r,H as F,E as p,a as I,u as je,n as T,P as R,B as c,at as V,W as te,_ as Xe,k as H,R as Ze,o as i,b as d,e as a,s as w,z as ve,A as ae,t as b,f as M,S as O,af as qe,F as ye,i as me,X as fe}from"./index-389b4023.js";import{P as ze}from"./PasswordInput-b2ae2ef6.js";import{M as le}from"./multisigUtils-cb5443af.js";import{A as Ge,a as Je}from"./AccountTabs-6a1ff422.js";import{M as Ye}from"./MetadataInput-bdce5b45.js";import{T as $e}from"./TransactionFeeDisplay-04fd5778.js";import{t as et}from"./jdenticon-module-fee33dc7.js";import{U as tt}from"./UTF8-1025235d.js";import{_ as at}from"./chevron_left-0423cb29.js";import"./functions-8fa37af4.js";import"./TextInput-1a41f229.js";import"./TextInputClean-4b373888.js";import"./icon-key-5b3f7dda.js";import"./icon-info-8b4f1351.js";import"./proximax-logo-ecfc3767.js";import"./icon-new-page-link-270844f6.js";const lt={name:"ViewUpdateAccountMetadata",props:{targetPublicKey:String,scopedMetadataKey:String},components:{AccountComponent:Ge,MetadataInput:Ye,PasswordInput:ze,AccountTabs:Je,TransactionFeeDisplay:$e},setup(o){const u=Oe();let Q=m(!1),t=m(!0),k=m(1),h=m(null),_=m(!1),K=m(""),g=m(""),y=m(null),x,L,U,s;const f=m(""),C=m(""),ne=new Qe("ThemeStyleConfig");ne.init();const pe=v(()=>et(y.value?y.value.address:"",40,ne.jdenticonConfig)),be=v(()=>y.value?r.currentLoggedInWallet.convertAddressToName(y.value.address,!0):""),oe=m([]),E=r.currentLoggedInWallet?r.currentLoggedInWallet.selectDefaultAccount():null,j=m(E?E.address:""),he=m(F.toCurrencyFormat(E?E.balance:0,p.nativeToken.divisibility)),se=e=>(e.endsWith("00")&&(e=e.substring(0,e.length-2),e=se(e)),e),X=e=>{e=se(e);let n=c.Convert.hexToUint8(e);return tt.isNotUTF8(n)||(e=c.Convert.decodeHexToUtf8(e)),e},xe=()=>{let e=new c.MetadataQueryParams;e.metadataType=c.MetadataType.ACCOUNT,e.targetKey=h.value,p.chainAPI.metadataAPI.searchMetadatas(e).then(n=>{n.metadataEntries.forEach(l=>{oe.value.push({value:l.scopedMetadataKey.toHex()==X(l.scopedMetadataKey.toHex())?l.scopedMetadataKey.toHex():X(l.scopedMetadataKey.toHex()),type:l.scopedMetadataKey.toHex()==X(l.scopedMetadataKey.toHex())?2:1})})})},_e=v(()=>y.value?y.value.address:"0".repeat(40)),Me=()=>{o.targetPublicKey.length===64&&c.Convert.isHexString(o.targetPublicKey)&&(h.value=c.PublicAccount.createFromPublicKey(o.targetPublicKey,p.networkType),x.targetPublicKey(h.value)),r.currentLoggedInWallet&&(y.value=r.currentLoggedInWallet.accounts.find(e=>e.publicKey===o.targetPublicKey)||r.currentLoggedInWallet.others.find(e=>e.publicKey===o.targetPublicKey),y.value&&(_.value=!!y.value.getDirectParentMultisig().length))},Ke=v(()=>r.currentLoggedInWallet&&h.value?r.currentLoggedInWallet.others.find(e=>e.publicKey===o.targetPublicKey):null);I(Ke,async e=>{if(e){if(!r.currentLoggedInWallet)return;y.value=r.currentLoggedInWallet.accounts.find(n=>n.publicKey===o.targetPublicKey)||r.currentLoggedInWallet.others.find(n=>n.publicKey===o.targetPublicKey),y.value&&(_.value=!!y.value.getDirectParentMultisig().length)}},{deep:!0});const Te=()=>{if(o.scopedMetadataKey)if(t.value=!1,g.value=o.scopedMetadataKey,o.scopedMetadataKey.length===16&&c.Convert.isHexString(o.scopedMetadataKey))k.value=2,K.value=o.scopedMetadataKey,x.scopedMetadataKey(c.UInt64.fromHex(K.value));else{let e=c.Convert.utf8ToHex(o.scopedMetadataKey);const n=e.length/2;e.length&&n<=8&&(k.value=1,e.length/2<8&&(e=e+"00".repeat(8-n)),K.value=e,x.scopedMetadataKey(c.UInt64.fromHex(K.value)))}},we=()=>{x=p.buildTxn.accountMetadataBuilder(),L=p.buildTxn.aggregateBondedBuilder()},ke=async()=>{if(h.value&&K.value){let e=new c.MetadataQueryParams;e.metadataType=c.MetadataType.ACCOUNT,e.targetKey=h.value,e.scopedMetadataKey=c.UInt64.fromHex(K.value);let n=await p.chainAPI.metadataAPI.searchMetadatas(e);n.metadataEntries.length&&(f.value=n.metadataEntries[0].value)}x.oldValue(f.value)},Ae=()=>{x.value(C.value)},Z=()=>{U=x.calculateDifferences().build()},q=()=>{U&&(s=L.innerTransactions([U.toAggregateV1(h)]).build())},z=()=>{s&&(S.value=s.maxFee.compact()/Math.pow(10,p.nativeToken.divisibility))},Pe=v(()=>p.nativeToken.label),{t:Ce}=je(),W=m(""),re=m(""),ce=r.currentLoggedInWallet?r.currentLoggedInWallet.name:"",G=v(()=>T.currentNetworkProfileConfig?F.convertToExact(T.currentNetworkProfileConfig.lockedFundsPerAggregate,p.nativeToken.divisibility):0),Ie=v(()=>T.currentNetworkProfileConfig?F.convertToCurrency(T.currentNetworkProfileConfig.lockedFundsPerAggregate,p.nativeToken.divisibility):0),J=v(()=>T.currentNetworkProfile?F.convertToExact(R.getLockFundFee(),p.nativeToken.divisibility):0),Ve="^[^ ]{8,}$",Se=m(!1),Y=v(()=>k.value==1?c.Convert.utf8ToHex(g.value).length/2>8:g.value.length>16?!0:g.value.length%2===1),ie=v(()=>Le.value<$.value),Fe=v(()=>Y.value==!0||g.value==""||C.value==""||!W.value.match(Ve)||ie.value==!0),N=v(()=>{if(!r.currentLoggedInWallet)return[];let e=r.currentLoggedInWallet.accounts.map(l=>({name:l.name,balance:l.balance,address:l.address,publicKey:l.publicKey,isMultisig:!!l.getDirectParentMultisig().length})),n=r.currentLoggedInWallet.others.filter(l=>l.type==="MULTISIG").map(l=>({name:l.name,balance:l.balance,address:l.address,publicKey:l.publicKey,isMultisig:!0}));return e.concat(n)});I(k,e=>{de(),e==2&&(c.Convert.isHexString(g.value)||(g.value=""))});const de=async()=>{if(Y.value||g.value.length==0)return;let e="";if(k.value==1){let D=c.Convert.utf8ToHex(g.value);e=D+"00".repeat((16-D.length)/2)}else e="00".repeat((16-g.value.length)/2)+g.value;let n=new c.MetadataQueryParams;n.targetKey=h.value,n.metadataType=c.MetadataType.ACCOUNT,n.scopedMetadataKey=c.UInt64.fromHex(e);let l=await p.chainAPI.metadataAPI.searchMetadatas(n);l.metadataEntries.length?f.value=l.metadataEntries[0].value:f.value=""},He=async()=>{if(!r.currentLoggedInWallet)return;if(!te.verifyWalletPassword(r.currentLoggedInWallet.name,T.chainNetworkName,W.value)){re.value=Ce("general.walletPasswordInvalid",{name:ce});return}let e="";if(k.value==1){let P=c.Convert.utf8ToHex(g.value);e=P+"00".repeat((16-P.length)/2)}else e="00".repeat((16-g.value.length)/2)+g.value;let n=x.targetPublicKey(h.value).scopedMetadataKey(c.UInt64.fromHex(e)).value(C.value).oldValue(f.value).calculateDifferences().build(),l=_.value?L.innerTransactions([n.toAggregateV1(h.value)]).build():p.buildTxn.aggregateCompleteBuilder().innerTransactions([n.toAggregateV1(h.value)]).build(),D=_.value?r.currentLoggedInWallet.accounts.find(P=>P.publicKey==A.value):r.currentLoggedInWallet.accounts.find(P=>P.publicKey==o.targetPublicKey),De=te.createPassword(W.value),Ee=te.decryptPrivateKey(De,D.encrypted,D.iv),ge=c.Account.createFromPrivateKey(Ee,p.networkType,1),ee=ge.preV2Sign(l,T.currentNetworkProfile.generationHash);if(_.value){let P=R.lockFundTx(ee),Re=ge.preV2Sign(P,T.currentNetworkProfile.generationHash);R.announceLF_AND_addAutoAnnounceABT(Re,ee)}else R.announceTransaction(ee);g.value="",f.value="",C.value="",W.value="",u.push({name:"ViewAccountPendingTransactions",params:{address:h.value.address.plain()}})},S=m(0),$=v(()=>{let e=p.nativeToken.divisibility;return _.value?e==0?Math.trunc(G.value+J.value+S.value):Math.round((G.value+J.value+S.value)*Math.pow(10,e))/Math.pow(10,e):S.value}),B=v(()=>!r.currentLoggedInWallet||!h.value?[]:le.getCosignerInWallet(o.targetPublicKey).cosignerList.length?N.value?le.getCosignerInWallet(o.targetPublicKey).cosignerList.map(e=>{let n=N.value.find(l=>l.publicKey==e);return{name:n.name,publicKey:e,balance:n.balance}}):[]:[]),A=m("");B.value.length>0&&(A.value=B.value[0].publicKey),I(()=>B,e=>{e.value.length&&(A.value=B.value[0].publicKey)},{deep:!0});const Le=v(()=>r.currentLoggedInWallet?_.value?A.value?V(A.value).balance:0:y.value?y.value.balance:0:0),Ue=v(()=>S.value.toString()),We=v(()=>F.amountFormatterSimple($.value,0)),Ne=v(()=>{if(T.currentNetworkProfileConfig){let e=le.getCosignerInWallet(N.value.find(l=>l.address==j.value)?N.value.find(l=>l.address==j.value).publicKey:""),n=[];return e.cosignerList.forEach(l=>{n.push({publicKey:l,name:V(l).name,balance:V(l).balance,address:V(l).address})}),e.cosignerList=n,e}else return{hasCosigner:!1,cosignerList:[]}}),Be=v(()=>{let e=V(A.value)?V(A.value).balance:0;return F.toCurrencyFormat(e,3)});I(f,e=>{x.oldValue(e),Z(),q(),z()}),I(C,e=>{x.value(e),Z(),q(),z()}),I(g,e=>{e==""&&(f.value="")});const ue=async()=>{we(),Me(),await Te(),await ke(),await Ae(),Z(),q(),z(),xe()};if(p.isReady)ue();else{let e=I(p,n=>{n.isReady&&(ue(),e())})}return{findAcc:V,totalFee:$,err:re,walletPassword:W,showPasswdError:Se,accounts:N,updateMetadata:He,targetAccIsMultisig:_,lockFundCurrency:Ie,lockFund:G,aggregateFee:S,lockFundTxFee:J,walletName:ce,currentNativeTokenName:Pe,oldValue:f,newValue:C,cosigners:B,scopedMetadataKeyType:k,svgString:pe,accountName:be,accountAddress:_e,disableAddBtn:Fe,showBalanceErr:ie,showScopedKeyErr:Y,inputScopedMetadataKey:g,checkOldValue:de,selectedCosigner:A,showKeys:Q,existingScopedMetadataKeys:oe,scopedMetadataKeySelectable:t,scopedMetadataKeyHex:K,transactionFee:Ue,totalFeeFormatted:We,selectedAccAdd:j,accBalance:he,getMultiSigCosigner:Ne,checkCosignBalance:Be}}},nt={class:"flex cursor-pointer"},ot=a("img",{src:at},null,-1),st={class:"lg:w-9/12 ml-2 mr-2 lg:ml-auto lg:mr-auto mt-5"},rt={class:"border-2 border-t-0 filter shadow-lg lg:grid lg:grid-cols-5"},ct={class:"lg:col-span-3 py-6 px-6"},it={class:"pl-6"},dt={key:0,class:"error error_box mb-5"},ut={key:0,class:"text-left mt-2 mb-5"},gt={key:0},vt={class:"text-tsm"},yt={key:0,class:"font-bold"},mt={key:1,class:"font-bold"},ft=["value"],pt={key:1,class:"error"},bt=a("div",{class:"font-semibold mb-4"},"Update Account Metadata",-1),ht={class:"border border-blue-300 rounded-md p-3 mt-3 bg-blue-50"},xt={class:"flex items-center gap-2"},_t=["innerHTML"],Mt={class:"flex flex-col gap-0.5"},Kt=a("div",{class:"uppercase text-xxs text-blue-primary"},"Selected Account",-1),Tt={class:"font-semibold"},wt={key:1,class:"mt-2"},kt=["onClick"],At={key:0,class:"text-xs py-2 bg-gray-100 pl-2 w-full"},Pt={key:1,class:"text-xs py-2 pl-2 w-full"},Ct={key:2,class:"ml-auto pr-2 text-xxs py-2 font-semibold uppercase text-blue-primary bg-gray-100"},It={key:3,class:"ml-auto mr-2 text-xxs py-2 font-semibold uppercase text-blue-primary"},Vt={key:2},St={class:"flex gap-3"},Ft={class:"flex gap-2"},Ht=a("label",{for:"regular"},"UTF-8",-1),Lt={class:"flex gap-2"},Ut=a("label",{for:"hexa"},"Hexadecimal",-1),Wt={key:3,class:"my-3"},Nt={class:"border border-blue-300 rounded-md p-3 mt-3 bg-blue-50"},Bt={class:"flex flex-col gap-0.5"},Dt=a("div",{class:"uppercase text-xxs text-blue-primary"},"Selected Scoped Metadata Key",-1),Et={class:"flex"},Rt={class:"font-semibold"},Ot={class:"ml-3 text-gray-400 font-semibold"},Qt={class:"flex"},jt={key:0,class:"font-semibold"},Xt={key:1,class:"ml-3 text-gray-400 font-semibold"},Zt={class:"border border-blue-300 rounded-md p-3 mt-3 bg-blue-50"},qt=a("div",{class:"uppercase text-xxs text-blue-primary"},"CURRENT VALUE",-1),zt={class:"font-semibold"},Gt={class:"bg-navy-primary p-6 lg:col-span-2"},Jt={class:"text-xs text-white my-5"},Yt=["disabled"],$t={class:"text-center"};function ea(o,u,Q,t,k,h){const _=H("router-link"),K=H("AccountComponent"),g=H("AccountTabs"),y=H("MetadataInput"),x=H("TransactionFeeDisplay"),L=H("PasswordInput"),U=Ze("debounce");return i(),d("div",null,[a("div",nt,[ot,w(_,{to:{name:"ViewDashboard"},class:"text-blue-primary text-xs mt-0.5"},{default:ve(()=>[ae(b(o.$t("general.back")),1)]),_:1})]),a("div",st,[w(K,{address:t.accountAddress,class:"mb-10"},null,8,["address"]),w(g,{address:t.accountAddress,selected:"metadata"},null,8,["address"]),a("div",rt,[a("div",ct,[a("div",it,[t.err!=""?(i(),d("div",dt,b(t.err),1)):M("v-if",!0)]),t.targetAccIsMultisig?(i(),d("div",ut,[t.cosigners.length>0?(i(),d("div",gt,[a("div",vt,[ae(b(o.$t("general.initiateBy"))+": ",1),t.cosigners.length==1?(i(),d("span",yt,b(t.cosigners[0].name),1)):(i(),d("span",mt,[O(a("select",{class:"","onUpdate:modelValue":u[0]||(u[0]=s=>t.selectedCosigner=s)},[(i(!0),d(ye,null,me(t.cosigners,(s,f)=>(i(),d("option",{value:t.findAcc(s.publicKey).publicKey,key:f},b(s.name),9,ft))),128))],512),[[qe,t.selectedCosigner]])]))])])):(i(),d("div",pt,b(o.$t("general.noCosigner")),1))])):M("v-if",!0),bt,a("div",ht,[a("div",xt,[a("div",{innerHTML:t.svgString},null,8,_t),a("div",Mt,[Kt,a("div",Tt,b(t.accountName),1)])])]),t.existingScopedMetadataKeys.length&&t.scopedMetadataKeySelectable?(i(),d("div",wt,[a("div",{onClick:u[1]||(u[1]=s=>t.showKeys=!t.showKeys),class:"text-blue-primary text-xs cursor-pointer mb-1.5"},"Select Existing Scoped Metadata Key"),(i(!0),d(ye,null,me(t.existingScopedMetadataKeys,(s,f)=>(i(),d("div",{key:f},[t.showKeys?(i(),d("div",{key:0,class:"flex justify-center cursor-pointer",onClick:C=>(t.scopedMetadataKeyType=s.type,t.inputScopedMetadataKey=s.value,t.checkOldValue(),t.showKeys=!1)},[f%2==0?(i(),d("div",At,b(s.value),1)):M("v-if",!0),f%2==1?(i(),d("div",Pt,b(s.value),1)):M("v-if",!0),f%2==0?(i(),d("div",Ct,b(o.$t("general.select")),1)):M("v-if",!0),f%2==1?(i(),d("div",It,b(o.$t("general.select")),1)):M("v-if",!0)],8,kt)):M("v-if",!0)]))),128))])):M("v-if",!0),t.scopedMetadataKeySelectable?(i(),d("div",Vt,[O(w(y,{hex:t.scopedMetadataKeyType==2,class:"mt-5",modelValue:t.inputScopedMetadataKey,"onUpdate:modelValue":u[2]||(u[2]=s=>t.inputScopedMetadataKey=s),placeholder:"Scoped Metadata Key",toolTip:`${t.scopedMetadataKeyType==1?"Accepts up to 8 bytes":"Accepts up to 16 hexadecimals"}`,showError:t.showScopedKeyErr,errorMessage:`${t.scopedMetadataKeyType==1?"Exceeded 8 bytes":t.inputScopedMetadataKey.length>16?"Exceeded 16 hexadecimals":"Input needs to be even number"}`},null,8,["hex","modelValue","toolTip","showError","errorMessage"]),[[U,t.checkOldValue,"1000"]]),a("div",St,[a("div",Ft,[O(a("input",{type:"radio",id:"regular",value:"1","onUpdate:modelValue":u[3]||(u[3]=s=>t.scopedMetadataKeyType=s)},null,512),[[fe,t.scopedMetadataKeyType]]),Ht]),a("div",Lt,[O(a("input",{type:"radio",id:"hexa",value:"2","onUpdate:modelValue":u[4]||(u[4]=s=>t.scopedMetadataKeyType=s)},null,512),[[fe,t.scopedMetadataKeyType]]),Ut])]),w(y,{class:"mt-2",modelValue:t.oldValue,"onUpdate:modelValue":u[5]||(u[5]=s=>t.oldValue=s),disabled:!0,placeholder:"Current Value"},null,8,["modelValue"])])):(i(),d("div",Wt,[a("div",Nt,[a("div",Bt,[Dt,a("div",Et,[a("div",Rt,b(Q.scopedMetadataKey),1),a("div",Ot,b(t.scopedMetadataKeyType==1?"UTF-8":"HEX"),1)]),a("div",Qt,[t.scopedMetadataKeyType==1?(i(),d("div",jt,b(t.scopedMetadataKeyHex),1)):M("v-if",!0),t.scopedMetadataKeyType==1?(i(),d("div",Xt,"HEX")):M("v-if",!0)])])]),a("div",Zt,[qt,a("div",zt,b(t.oldValue),1)])])),w(y,{class:"mt-2",modelValue:t.newValue,"onUpdate:modelValue":u[6]||(u[6]=s=>t.newValue=s),placeholder:"New Value"},null,8,["modelValue"])]),a("div",Gt,[w(x,{"transaction-fee":t.transactionFee,"total-fee-formatted":t.totalFeeFormatted,"get-multi-sig-cosigner":t.getMultiSigCosigner,"check-cosign-balance":t.checkCosignBalance,"lock-fund-currency":String(t.lockFundCurrency),"lock-fund-tx-fee":String(t.lockFundTxFee),balance:t.accBalance,"selected-acc-add":t.selectedAccAdd},null,8,["transaction-fee","total-fee-formatted","get-multi-sig-cosigner","check-cosign-balance","lock-fund-currency","lock-fund-tx-fee","balance","selected-acc-add"]),a("div",Jt,b(o.$t("general.enterPasswordContinue")),1),w(L,{placeholder:o.$t("general.enterPassword"),errorMessage:o.$t("general.passwordRequired"),modelValue:t.walletPassword,"onUpdate:modelValue":u[7]||(u[7]=s=>t.walletPassword=s),icon:"lock",class:"mt-5 mb-3"},null,8,["placeholder","errorMessage","modelValue"]),a("button",{type:"submit",class:"w-full blue-btn px-3 py-3 disabled:opacity-50 disabled:cursor-auto",onClick:u[8]||(u[8]=s=>t.updateMetadata()),disabled:t.disableAddBtn}," Update Account Metadata ",8,Yt),a("div",$t,[w(_,{to:{name:"ViewAccountMetadata",params:{address:t.accountAddress}},class:"content-center text-xs text-white underline"},{default:ve(()=>[ae(b(o.$t("general.cancel")),1)]),_:1},8,["to"])])])])])])}const pa=Xe(lt,[["render",ea],["__file","/home/runner/work/web-wallet-vuejs/web-wallet-vuejs/src/modules/metadataTxn/views/ViewUpdateAccountMetadata.vue"]]);export{pa as default};
